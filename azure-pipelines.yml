# CI/CD on self-hosted Windows agent: build → load to Minikube → kubectl apply
trigger:
  branches:
    include: ["main", "*"]

variables:
  IMAGE_NAME: devops-capstone
  LOCAL_TAG: local
  NAMESPACE: devops-capstone

stages:
# --- CI: tests (uses local Python, no UsePythonVersion) ---
- stage: test
  displayName: Run unit tests
  jobs:
  - job: pytest
    pool:
      name: Capstone      
    steps:
    - checkout: self
    - script: |
        echo === Python installations discovered ===
        py --list || ver
        echo === Using local Python 3.11 ===
        py -3.11 -m pip install --upgrade pip
        py -3.11 -m pip install -r app/requirements.txt pytest
        py -3.11 -m pytest -q app/test_app.py
      displayName: Use local Python 3.11 to run tests

# --- CD: build + load + deploy to Minikube ---
- stage: build_deploy
  displayName: Build Docker image & deploy to Minikube
  dependsOn: test
  condition: succeeded()
  jobs:
  - job: build_and_deploy
    pool:
      name: Capstone      # <-- change if needed
    steps:
    - checkout: self

    - script: |
        echo Checking Minikube...
        minikube status || minikube start
        kubectl config use-context minikube
        kubectl get nodes
      displayName: Ensure Minikube is running

    - script: |
        echo Building Docker image...
        docker build -t $(IMAGE_NAME):$(LOCAL_TAG) .
        docker images | findstr $(IMAGE_NAME)
      displayName: Docker build

    - script: |
        echo Loading image into Minikube...
        minikube image load $(IMAGE_NAME):$(LOCAL_TAG)
      displayName: Minikube image load

    - script: |
        echo Applying Kubernetes manifests...
        kubectl apply -n $(NAMESPACE) -f k8s/deployment.yaml
        kubectl apply -n $(NAMESPACE) -f k8s/service.yaml
        kubectl apply -n $(NAMESPACE) -f k8s/hpa.yaml
        echo Patching image tag...
        kubectl -n $(NAMESPACE) set image deploy/devops-capstone web=$(IMAGE_NAME):$(LOCAL_TAG) --record || true
        echo Current objects:
        kubectl -n $(NAMESPACE) get deploy,rs,pods,svc,hpa -o wide
      displayName: kubectl apply & patch
